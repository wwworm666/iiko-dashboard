<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Управление кранами</title>
<style>
html,body{height:100%;margin:0;font-family:Arial,sans-serif;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));grid-auto-rows:1fr;height:100vh;}
.tile{display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;font-size:2rem;font-weight:bold;cursor:pointer;}
.tile.stop{background:#c0392b;}
.tile.active{background:#27ae60;}
.tile .tap-id{margin-top:auto;font-size:.8rem;opacity:.8;padding-bottom:.5rem;}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;}
.modal.open{display:flex;}
.modal-content{background:#fff;padding:1rem;border-radius:8px;width:90%;max-width:400px;}
.modal-content h2{margin-top:0;}
.modal-content input{width:100%;padding:.5rem;margin-bottom:.5rem;}
.actions{display:flex;flex-wrap:wrap;gap:.5rem;}
.actions button{flex:1;padding:.5rem;font-size:1rem;cursor:pointer;}
</style>
</head>
<body>
<div class="grid" id="tapsGrid"></div>
<div class="modal" id="actionModal">
  <div class="modal-content">
    <h2 id="modalTitle"></h2>
    <input type="text" id="beerInput" placeholder="Название пива" list="beerSuggestions">
    <datalist id="beerSuggestions"></datalist>
    <div class="actions">
      <button id="startBtn">ПУСК</button>
      <button id="stopBtn">СТОП</button>
      <button id="replaceBtn">ЗАМЕНА</button>
      <button id="cancelBtn">Отмена</button>
    </div>
  </div>
</div>
<script>
let taps={};
let currentTap=null;
let selectedAction='start';
let serverNames=[];
function loadServerNames(){
  return fetch('/api/beer-names').then(r=>r.json()).then(n=>{serverNames=n;updateSuggestions();});
}
function loadLocalNames(){
  try{return JSON.parse(localStorage.getItem('beerNames'))||{};}catch(e){return {};}
}
function saveLocalName(name){
  const names=loadLocalNames();
  const key=name.trim();
  const now=Date.now();
  if(names[key]){names[key].count++;}else{names[key]={count:1};}
  names[key].lastUsed=now;
  localStorage.setItem('beerNames',JSON.stringify(names));
}
function updateSuggestions(){
  const local=loadLocalNames();
  const merged={};
  serverNames.forEach(n=>merged[n.toLowerCase()]={name:n,count:0,lastUsed:0});
  Object.keys(local).forEach(n=>merged[n.toLowerCase()]={name:n,count:local[n].count,lastUsed:local[n].lastUsed||0});
  const list=document.getElementById('beerSuggestions');
  const sorted=Object.values(merged).sort((a,b)=>b.count-a.count||b.lastUsed-a.lastUsed).map(o=>o.name);
  list.innerHTML=sorted.map(n=>`<option value="${n}">`).join('');
}
function saveServerName(name){
  fetch('/api/beer-names',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
}
function loadTaps(){
  return fetch('/api/taps').then(r=>r.json()).then(data=>{taps=data;renderGrid();});
}
function renderGrid(){
  const grid=document.getElementById('tapsGrid');
  grid.innerHTML='';
  Object.keys(taps).forEach(id=>{
    const info=taps[id];
    const tile=document.createElement('div');
    tile.className='tile '+(info.status==='ACTIVE'?'active':'stop');
    tile.innerHTML=`<div>${info.status==='ACTIVE'?info.beer:'СТОП'}</div><span class="tap-id">${id}</span>`;
    tile.addEventListener('click',()=>openModal(id));
    grid.appendChild(tile);
  });
}
function openModal(id){
  currentTap=id;
  document.getElementById('modalTitle').textContent=id;
  const input=document.getElementById('beerInput');
  const last=localStorage.getItem('lastBeer_'+id);
  input.value=taps[id].status==='ACTIVE'?taps[id].beer:(last||'');
  selectedAction=taps[id].status==='ACTIVE'?'stop':'start';
  document.getElementById('actionModal').classList.add('open');
  input.focus();
}
function closeModal(){
  document.getElementById('actionModal').classList.remove('open');
}
function sendAction(action){
  const beer=document.getElementById('beerInput').value.trim();
  if((action==='start'||action==='replace')&&!beer)return;
  const body={action};
  if(action!=='stop')body.beer=beer;
  fetch('/api/taps/'+currentTap.replace('TAP',''),{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
  }).then(r=>r.json()).then(()=>{
    if(action!=='stop'){
      saveLocalName(beer);saveServerName(beer);localStorage.setItem('lastBeer_'+currentTap,beer);
    }
    closeModal();loadTaps();
  });
}
document.getElementById('startBtn').onclick=()=>{selectedAction='start';sendAction('start');};
document.getElementById('stopBtn').onclick=()=>{selectedAction='stop';sendAction('stop');};
document.getElementById('replaceBtn').onclick=()=>{selectedAction='replace';sendAction('replace');};
document.getElementById('cancelBtn').onclick=closeModal;
document.getElementById('actionModal').addEventListener('click',e=>{if(e.target.id==='actionModal')closeModal();});
document.addEventListener('keydown',e=>{
  if(document.getElementById('actionModal').classList.contains('open')){
    if(e.key==='Escape') closeModal();
    if(e.key==='Enter') sendAction(selectedAction);
  }
});
loadServerNames().then(loadTaps);
</script>
</body>
</html>
